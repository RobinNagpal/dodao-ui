// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

generator json {
  provider  = "prisma-json-types-generator"
  namespace = "PrismaJson"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// --------------------------
// Existing Models
// --------------------------

enum UserRole {
  FreeUser
  Admin
}

model User {
  id            String    @id @default(cuid())
  name          String?
  email         String?
  emailVerified DateTime? @map("email_verified")
  image         String?
  publicAddress String?   @map("public_address")
  phoneNumber   String?   @map("phone_number")
  walletAddress String[]  @default([]) @map("wallet_address")

  spaceId      String    @map("space_id")
  username     String    @map("username")
  authProvider String    @map("auth_provider")
  role         UserRole  @default(FreeUser) @map("role")
  accounts     Account[]
  sessions     Session[]

  // User ticker related relations
  tickerTags       UserTickerTag[]
  tickerLists      UserTickerList[]
  favouriteTickers FavouriteTicker[]
  tickerNotes      TickerV1Notes[]

  // Portfolio related relations
  portfolioManagerProfile PortfolioManagerProfile?

  @@unique([publicAddress, spaceId])
  @@unique([username, spaceId])
  @@unique([email, spaceId])
  @@map("users")
}

model Account {
  id                String  @id @default(cuid())
  userId            String  @map("user_id")
  type              String
  provider          String
  providerAccountId String  @map("provider_account_id")
  refresh_token     String? @map("refresh_token")
  access_token      String? @map("access_token")
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?
  user              User    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@map("accounts")
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique @map("session_token")
  userId       String   @map("user_id")
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("sessions")
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
  @@map("verification_tokens")
}

model Ticker {
  id                           String   @id @default(uuid())
  tickerKey                    String   @unique @map("ticker_key")
  createdAt                    DateTime @default(now()) @map("created_at")
  updatedAt                    DateTime @updatedAt @map("updated_at")
  createdBy                    String?  @map("created_by")
  updatedBy                    String?  @map("updated_by")
  sectorId                     Int      @map("sector_id")
  industryGroupId              Int      @map("industry_group_id")
  spaceId                      String   @default("koala_gains") @map("space_id")
  // latest10QInformationId       String?  @map("latest_10q_information_id")
  latest10QFinancialStatements String?  @map("latest_10q_financial_statements")
  companyName                  String   @default("Unknown Company") @map("company_name")
  shortDescription             String   @default("No description provided") @map("short_description")
  tickerInfo                   String?  @map("ticker_info")
  managementTeam               Json?    @map("management_team")

  evaluationsOfLatest10Q         CriterionEvaluation[]
  secFilings                     SecFiling[]
  ImportantMetrics               ImportantMetricsEvaluation[]
  MetricValueItem                MetricValueItem[]
  CriterionReportItem            CriterionReportItem[]
  PerformanceChecklistEvaluation PerformanceChecklistEvaluation[]
  PerformanceChecklistItem       PerformanceChecklistItem[]
  CriterionMatch                 CriterionMatch[]
  criteriaMatchesOfLatest10Q     CriteriaMatchesOfLatest10Q?
  latest10QInfo                  Latest10QInfo?

  // latest10QInformation           Latest10QInformation?            @relation(fields: [latest10QInformationId], references: [id])
  @@unique([spaceId, tickerKey])
  @@map("tickers")
}

model SecFiling {
  id              String   @id @default(uuid())
  tickerKey       String   @map("ticker_key")
  filingDate      DateTime @map("filing_date")
  form            String   @map("form")
  filingUrl       String   @map("filing_url")
  accessionNumber String   @unique @map("accession_number")
  periodOfReport  String   @map("period_of_report")
  shortSummary    String?  @map("short_summary")
  spaceId         String   @default("koala_gains") @map("space_id")

  attachments SecFilingAttachment[]
  ticker      Ticker                @relation(fields: [tickerKey], references: [tickerKey])

  @@map("sec_filings")
}

// Model for Filing attachments using UUIDs.
model SecFilingAttachment {
  id             String    @id @default(uuid())
  sequenceNumber String    @map("sequence_number")
  description    String    @map("description")
  purpose        String?   @map("purpose")
  url            String    @map("url")
  documentType   String    @map("document_type")
  secFilingId    String    @map("sec_filing_id")
  secFiling      SecFiling @relation(fields: [secFilingId], references: [id])
  spaceId        String    @default("koala_gains") @map("space_id")

  @@map("sec_filing_attachments")
}

enum FormSize {
  xs
  s
  m
  l
  xl
}

model SecForm {
  formName         String   @id @map("form_name")
  formDescription  String   @map("form_description")
  importantItems   Json     @map("important_items")
  averagePageCount Int      @map("average_page_count")
  size             FormSize @map("size")
}

// --------------------------
// New Ticker Report Models (All IDs as UUID)
// --------------------------

enum ProcessingStatus {
  Completed
  Failed
  InProgress
  NotStarted
}

model CriterionEvaluation {
  id           String @id @default(uuid())
  tickerKey    String @map("ticker_key")
  criterionKey String @map("criterion_key")
  spaceId      String @default("koala_gains") @map("space_id")

  importantMetricsEvaluation     ImportantMetricsEvaluation?
  performanceChecklistEvaluation PerformanceChecklistEvaluation?
  reports                        CriterionReportItem[]
  ticker                         Ticker                          @relation(fields: [tickerKey], references: [tickerKey])

  @@unique([spaceId, tickerKey, criterionKey])
  @@map("criterion_evaluations")
}

model ImportantMetricsEvaluation {
  id                    String           @id @default(uuid())
  status                ProcessingStatus
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")
  createdBy             String?          @map("created_by")
  updatedBy             String?          @map("updated_by")
  tickerKey             String           @map("ticker_key")
  criterionKey          String           @map("criterion_key")
  spaceId               String           @default("koala_gains") @map("space_id")
  criterionEvaluationId String?          @unique @map("criterion_evaluation_id")

  criterionEvaluation CriterionEvaluation? @relation(fields: [criterionEvaluationId], references: [id])
  ticker              Ticker               @relation(fields: [tickerKey], references: [tickerKey])
  metrics             MetricValueItem[]

  @@unique([spaceId, tickerKey, criterionKey])
  @@map("important_metrics")
}

model MetricValueItem {
  id                     String @id @default(uuid())
  metricKey              String @map("metric_key")
  value                  String @map("value")
  calculationExplanation String @map("calculation_explanation")
  allInformationUsed     String @default("Not provided") @map("all_information_used")
  tickerKey              String @map("ticker_key")
  criterionKey           String @map("criterion_key")
  importantMetricsId     String @map("important_metrics_id")
  spaceId                String @default("koala_gains") @map("space_id")

  importantMetrics ImportantMetricsEvaluation @relation(fields: [importantMetricsId], references: [id])
  ticker           Ticker                     @relation(fields: [tickerKey], references: [tickerKey])

  @@map("metric_value_items")
}

model CriterionReportItem {
  id                    String           @id @default(uuid())
  reportKey             String           @map("report_key")
  status                ProcessingStatus @map("status")
  textData              String?          @map("data")
  jsonData              Json?            @map("json_data")
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")
  createdBy             String?          @map("created_by")
  updatedBy             String?          @map("updated_by")
  tickerKey             String           @map("ticker_key")
  criterionKey          String           @map("criterion_key")
  criterionEvaluationId String           @map("criterion_evaluation_id")
  spaceId               String           @default("koala_gains") @map("space_id")

  criterionEvaluation CriterionEvaluation @relation(fields: [criterionEvaluationId], references: [id])
  ticker              Ticker              @relation(fields: [tickerKey], references: [tickerKey])

  @@unique([spaceId, tickerKey, criterionKey, reportKey])
  @@map("criterion_report_items")
}

model PerformanceChecklistEvaluation {
  id                    String           @id @default(uuid())
  status                ProcessingStatus @map("status")
  createdAt             DateTime         @default(now()) @map("created_at")
  updatedAt             DateTime         @updatedAt @map("updated_at")
  createdBy             String?          @map("created_by")
  updatedBy             String?          @map("updated_by")
  tickerKey             String           @map("ticker_key")
  criterionKey          String           @map("criterion_key")
  criterionEvaluationId String?          @unique @map("criterion_evaluation_id")
  spaceId               String           @default("koala_gains") @map("space_id")

  criterionEvaluation       CriterionEvaluation?       @relation(fields: [criterionEvaluationId], references: [id])
  ticker                    Ticker                     @relation(fields: [tickerKey], references: [tickerKey])
  performanceChecklistItems PerformanceChecklistItem[]

  @@unique([spaceId, tickerKey, criterionKey])
  @@map("performance_checklist_evaluations")
}

model PerformanceChecklistItem {
  id                               String  @id @default(uuid())
  metricKey                        String? @map("metric_key")
  checklistItem                    String  @map("checklist_item")
  oneLinerExplanation              String  @map("one_liner_explanation")
  informationUsed                  String  @map("information_used")
  detailedExplanation              String  @map("detailed_explanation")
  evaluationLogic                  String  @map("evaluation_logic")
  score                            Float   @map("score")
  tickerKey                        String  @map("ticker_key")
  criterionKey                     String  @map("criterion_key")
  performanceChecklistEvaluationId String  @map("performance_checklist_evaluation_id")
  spaceId                          String  @default("koala_gains") @map("space_id")

  performanceChecklistEvaluation PerformanceChecklistEvaluation @relation(fields: [performanceChecklistEvaluationId], references: [id])
  ticker                         Ticker                         @relation(fields: [tickerKey], references: [tickerKey])

  @@map("performance_checklist_items")
}

model CriteriaMatchesOfLatest10Q {
  id                                String           @id @default(uuid())
  status                            ProcessingStatus @map("status")
  createdAt                         DateTime         @default(now()) @map("created_at")
  updatedAt                         DateTime         @updatedAt @map("updated_at")
  createdBy                         String?          @map("created_by")
  updatedBy                         String?          @map("updated_by")
  failureReason                     String?          @map("failure_reason")
  tickerKey                         String           @map("ticker_key")
  tickerId                          String           @unique @map("ticker_id")
  spaceId                           String           @default("koala_gains") @map("space_id")
  matchingAttachmentsCount          Int?             @map("matching_attachments_count")
  matchingAttachmentsProcessedCount Int?             @map("matching_attachments_processed_count")

  criterionMatches CriterionMatch[]
  ticker           Ticker           @relation(fields: [tickerId], references: [id])

  @@unique([spaceId, tickerKey])
  @@map("criteria_matches_latest_10q")
}

model CriterionMatch {
  id                            String @id @default(uuid())
  criterionKey                  String @map("criterion_key")
  matchedContent                String @map("matched_content")
  tickerKey                     String @map("ticker_key")
  spaceId                       String @default("koala_gains") @map("space_id")
  criterionMatchesOfLatest10QId String @map("criterion_matches_latest_10q_id")

  criterionMatchesOfLatest10Q CriteriaMatchesOfLatest10Q @relation(fields: [criterionMatchesOfLatest10QId], references: [id], onDelete: Cascade)
  ticker                      Ticker                     @relation(fields: [tickerKey], references: [tickerKey])

  @@unique([spaceId, tickerKey, criterionKey])
  @@map("criterion_matches")
}

model Prompt {
  id                  String          @id @default(uuid())
  spaceId             String          @map("space_id")
  name                String          @map("name")
  key                 String          @map("key")
  excerpt             String?         @map("excerpt")
  inputSchema         String?         @map("input_schema")
  outputSchema        String          @map("output_schema")
  sampleJson          String?         @map("sample_json")
  sampleBodyToAppend  String?         @map("sample_body_to_append")
  transformationPatch Json?           @map("transformation_patch") @db.JsonB
  createdAt           DateTime        @default(now()) @map("created_at")
  updatedAt           DateTime        @updatedAt @map("updated_at")
  createdBy           String          @map("created_by")
  updatedBy           String          @map("updated_by")
  notes               String?         @map("notes")
  promptVersions      PromptVersion[]

  activePromptVersionId String?            @unique @map("active_prompt_version_id")
  activePromptVersion   PromptVersion?     @relation("ActivePromptVersion", fields: [activePromptVersionId], references: [id])
  PromptInvocation      PromptInvocation[]
  analysisTemplates     AnalysisTemplate[]

  @@unique([spaceId, key])
  @@map("prompts")
}

model PromptVersion {
  id             String   @id @default(uuid())
  spaceId        String   @map("space_id")
  promptId       String   @map("prompt_id")
  version        Int      @map("version")
  promptTemplate String   @map("prompt_template")
  commitMessage  String?  @map("commit_message")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")
  createdBy      String   @map("created_by")
  updatedBy      String   @map("updated_by")

  prompt Prompt @relation(fields: [promptId], references: [id])

  activeInPrompt Prompt? @relation("ActivePromptVersion")

  promptInvocations PromptInvocation[]

  @@unique([promptId, version])
  @@map("prompt_versions")
}

enum PromptInvocationStatus {
  Completed
  Failed
  InProgress
  NotStarted
}

model PromptInvocation {
  id                 String                 @id @default(uuid())
  spaceId            String                 @map("space_id")
  promptId           String                 @map("prompt_id")
  promptVersionId    String                 @map("prompt_version_id")
  inputJson          Json?                  @map("input_json") @db.JsonB
  outputJson         Json?                  @map("output_json") @db.JsonB
  transformedJson    Json?                  @map("transformed_json") @db.JsonB
  status             PromptInvocationStatus @map("status")
  error              String?                @map("error")
  createdAt          DateTime               @default(now()) @map("created_at")
  updatedAt          DateTime               @updatedAt @map("updated_at")
  createdBy          String                 @map("created_by")
  updatedBy          String                 @map("updated_by")
  bodyToAppend       String?                @map("body_to_append")
  llmProvider        String                 @map("llm_provider")
  model              String                 @map("model")
  promptRequestToLlm String?                @map("prompt_request_to_llm")
  prompt             Prompt                 @relation(fields: [promptId], references: [id])
  promptVersion      PromptVersion          @relation(fields: [promptVersionId], references: [id])

  @@map("prompt_invocations")
}

model TestPromptInvocation {
  id              String                 @id @default(uuid())
  spaceId         String                 @map("space_id")
  promptId        String                 @map("prompt_id")
  promptTemplate  String                 @map("prompt_template")
  inputJson       Json?                  @map("input_json") @db.JsonB
  bodyToAppend    String?                @map("body_to_append")
  outputJson      Json?                  @map("output_json") @db.JsonB
  transformedJson Json?                  @map("transformed_json") @db.JsonB
  status          PromptInvocationStatus @map("status")
  error           String?                @map("error")
  createdAt       DateTime               @default(now()) @map("created_at")
  updatedAt       DateTime               @updatedAt @map("updated_at")
  createdBy       String                 @map("created_by")
  updatedBy       String                 @map("updated_by")
  llmProvider     String                 @map("llm_provider")
  model           String                 @map("model")

  @@map("test_prompt_invocations")
}

model Latest10QInfo {
  id               String @id @default(uuid())
  spaceId          String @default("koala_gains") @map("space_id")
  tickerKey        String @unique @map("ticker_key")
  filingUrl        String @map("filing_url")
  periodOfReport   String @map("period_of_report")
  filingDate       String @map("filing_date")
  priceAtPeriodEnd Float  @map("price_at_period_end")

  ticker Ticker @relation(fields: [tickerKey], references: [tickerKey])

  @@unique([spaceId, tickerKey])
  @@map("latest_10q_infos")
}

enum EvaluationResult {
  Pass
  Fail
}

enum TickerAnalysisCategory {
  BusinessAndMoat
  FinancialStatementAnalysis
  PastPerformance
  FutureGrowth
  VsCompetition
  FairValue
}

// --------------------------
// New Tables (convention-aligned)
// --------------------------

model TickerV1Industry {
  industryKey String  @id @map("industry_key")
  name        String  @map("name")
  summary     String  @map("summary")
  archived    Boolean @default(false) @map("archived")

  subIndustries          TickerV1SubIndustry[]
  tickers                TickerV1[]               @relation("IndustryTickers")
  AnalysisCategoryFactor AnalysisCategoryFactor[]
  industryAnalyses       TickerV1IndustryAnalysis[]

  @@index([industryKey])
}

model TickerV1SubIndustry {
  subIndustryKey String  @map("sub_industry_key")
  name           String  @map("name")
  summary        String  @map("summary")
  industryKey    String  @map("industry_key")
  archived       Boolean @default(false) @map("archived")

  industry TickerV1Industry @relation(fields: [industryKey], references: [industryKey])

  // optional backref to tickers
  tickers                TickerV1[]               @relation("SubIndustryTickers")
  AnalysisCategoryFactor AnalysisCategoryFactor[]

  // âœ… Composite primary key (the lynchpin of Option B)
  @@id([industryKey, subIndustryKey])
  @@index([industryKey])
}

model TickerV1 {
  id              String   @id @default(uuid())
  name            String   @map("name")
  symbol          String   @map("symbol")
  exchange        String   @map("exchange")
  industryKey     String   @map("industry_key")
  subIndustryKey  String   @map("sub_industry_key")
  websiteUrl      String?  @map("website_url")
  summary         String?  @map("summary")
  aboutReport     String?  @map("about_report")
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")
  createdBy       String?  @map("created_by")
  updatedBy       String?  @map("updated_by")
  metaDescription String?  @map("meta_description")
  spaceId         String   @default("koala_gains") @map("space_id")
  stockAnalyzeUrl String   @map("stock_analyze_url")

  // Direct FK to industry (for quick joins/filters)
  industry                TickerV1Industry                       @relation("IndustryTickers", fields: [industryKey], references: [industryKey], onUpdate: Cascade, onDelete: Restrict)
  // Composite FK to subindustry: *enforces the pairing*
  subIndustry             TickerV1SubIndustry                    @relation("SubIndustryTickers", fields: [industryKey, subIndustryKey], references: [industryKey, subIndustryKey], onUpdate: Cascade, onDelete: Restrict)
  // Relations
  categoryAnalysisResults TickerV1CategoryAnalysisResult[]
  factorResults           TickerV1AnalysisCategoryFactorResult[]
  investorAnalysisResults TickerV1InvestorAnalysisResult[]
  futureRisks             TickerV1FutureRisk[]
  vsCompetition           TickerV1VsCompetition?
  generationRequests      TickerV1GenerationRequest[]

  // Relation to cached score
  cachedScoreEntry TickerV1CachedScore?

  financialInfo TickerV1FinancialInfo?

  // Relation to stock analyzer scrapper info (one-to-one)
  stockAnalyzerScrapperInfo TickerV1StockAnalyzerScrapperInfo?

  // Relation to favourite tickers
  favouriteTickers FavouriteTicker[]

  // Relation to portfolio tickers
  portfolioTickers PortfolioTicker[]

  // Relation to daily market movements
  dailyTopGainers DailyTopGainer[] @relation("DailyTopGainerTickers")
  dailyTopLosers  DailyTopLoser[]  @relation("DailyTopLoserTickers")

  // Relation to ticker notes
  tickerNotes TickerV1Notes[]

  // Relation to detailed reports
  tickerDetailedReports TickerV1DetailedReport[]

  @@unique([spaceId, symbol, exchange])
  // ðŸ”Ž simple FK indexes (good practice; Postgres doesn't auto-index FKs)
  @@index([industryKey])
  @@index([subIndustryKey])
  @@map("tickers_v1")
}

model TickerV1FinancialInfo {
  id              String  @id @default(uuid())
  tickerId        String  @unique @map("ticker_id")
  currency        String? @map("currency")
  price           Float?  @map("price")
  dayHigh         Float?  @map("day_high")
  dayLow          Float?  @map("day_low")
  yearHigh        Float?  @map("year_high")
  yearLow         Float?  @map("year_low")
  marketCap       Float?  @map("market_cap")
  epsDilutedTTM   Float?  @map("eps_diluted_ttm")
  pe              Float?  @map("pe_ratio")
  avgVolume3M     Float?  @map("avg_volume_3m")
  dayVolume       Float?  @map("day_volume")
  annualDividend  Float?  @map("annual_dividend")
  dividendYield   Float?  @map("dividend_yield")
  totalRevenue    Float?  @map("total_revenue")
  netIncome       Float?  @map("net_income")
  netProfitMargin Float?  @map("net_profit_margin")

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Relation back to TickerV1
  ticker TickerV1 @relation(fields: [tickerId], references: [id])

  @@index([tickerId])
  @@map("ticker_v1_financial_info")
}

model TickerV1CachedScore {
  id       String @id @default(uuid())
  tickerId String @map("ticker_id")

  // Scores for each category
  businessAndMoatScore            Int @map("business_and_moat_score")
  financialStatementAnalysisScore Int @map("financial_statement_analysis_score")
  pastPerformanceScore            Int @map("past_performance_score")
  futureGrowthScore               Int @map("future_growth_score")
  fairValueScore                  Int @map("fair_value_score")

  // Final score
  finalScore Int @map("final_score")

  // Relation to TickerV1
  ticker TickerV1 @relation(fields: [tickerId], references: [id])

  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")

  createdBy String? @map("created_by")
  updatedBy String? @map("updated_by")

  @@unique([tickerId]) // each ticker has only one cached score entry
  @@index([tickerId])
  @@map("ticker_v1_cached_scores")
}

model AnalysisCategoryFactor {
  id                        String                                 @id @default(uuid())
  industryKey               String                                 @map("industry_key")
  subIndustryKey            String                                 @map("sub_industry_key")
  categoryKey               TickerAnalysisCategory                 @map("category_key")
  factorAnalysisKey         String                                 @map("factor_analysis_key")
  factorAnalysisTitle       String                                 @map("factor_analysis_title")
  factorAnalysisDescription String                                 @map("factor_analysis_description")
  factorAnalysisMetrics     String?                                @map("factor_analysis_metrics")
  createdAt                 DateTime                               @default(now()) @map("created_at")
  updatedAt                 DateTime                               @updatedAt @map("updated_at")
  createdBy                 String?                                @map("created_by")
  updatedBy                 String?                                @map("updated_by")
  spaceId                   String                                 @default("koala_gains") @map("space_id")
  // Enforce valid industry
  industry                  TickerV1Industry                       @relation(fields: [industryKey], references: [industryKey], onUpdate: Cascade, onDelete: Restrict)
  // Enforce valid (industryKey, subIndustryKey) pairing
  subIndustry               TickerV1SubIndustry                    @relation(fields: [industryKey, subIndustryKey], references: [industryKey, subIndustryKey], onUpdate: Cascade, onDelete: Restrict)
  // Backrefs
  factorResults             TickerV1AnalysisCategoryFactorResult[]

  @@unique([spaceId, industryKey, subIndustryKey, categoryKey, factorAnalysisKey])
  @@map("analysis_category_factors")
}

model TickerV1CategoryAnalysisResult {
  id                     String                 @id @default(uuid())
  categoryKey            TickerAnalysisCategory @map("category_key")
  summary                String                 @map("summary")
  overallAnalysisDetails String                 @map("introduction_to_analysis")
  tickerId               String                 @map("ticker_id")
  spaceId                String                 @default("koala_gains") @map("space_id")
  createdAt              DateTime               @default(now()) @map("created_at")
  updatedAt              DateTime               @updatedAt @map("updated_at")
  createdBy              String?                @map("created_by")
  updatedBy              String?                @map("updated_by")

  ticker TickerV1 @relation(fields: [tickerId], references: [id])

  // ðŸ‘‡ back-reference so you can `include` factor results
  factorResults TickerV1AnalysisCategoryFactorResult[]

  @@unique([spaceId, tickerId, categoryKey])
  @@index([tickerId])
  @@map("ticker_v1_category_analysis_results")
}

model TickerV1AnalysisCategoryFactorResult {
  id                       String                 @id @default(uuid())
  categoryKey              TickerAnalysisCategory @map("category_key")
  analysisCategoryFactorId String                 @map("analysis_category_factor_id")
  oneLineExplanation       String                 @map("one_line_explanation")
  detailedExplanation      String                 @map("detailed_explanation")
  result                   EvaluationResult       @map("result")
  tickerId                 String                 @map("ticker_id")
  spaceId                  String                 @default("koala_gains") @map("space_id")
  createdAt                DateTime               @default(now()) @map("created_at")
  updatedAt                DateTime               @updatedAt @map("updated_at")
  createdBy                String?                @map("created_by")
  updatedBy                String?                @map("updated_by")

  ticker                 TickerV1               @relation(fields: [tickerId], references: [id])
  analysisCategoryFactor AnalysisCategoryFactor @relation(fields: [analysisCategoryFactorId], references: [id])

  // ðŸ‘‡ new relation tying child to parent via the parent's composite unique
  categoryAnalysisResult TickerV1CategoryAnalysisResult @relation(fields: [spaceId, tickerId, categoryKey], references: [spaceId, tickerId, categoryKey], onDelete: Cascade)

  @@unique([spaceId, tickerId, analysisCategoryFactorId])
  @@index([tickerId])
  @@index([analysisCategoryFactorId])
  @@index([spaceId, tickerId, categoryKey], name: "factor_results_by_parent")
  @@map("ticker_v1_analysis_category_factor_results")
}

model TickerV1InvestorAnalysisResult {
  id                     String   @id @default(uuid())
  investorKey            String   @map("investor_key") // e.g. "WARREN_BUFFETT"
  summary                String   @map("summary")
  verdict                String   @default("PENDING") @map("verdict")
  willInvest             Boolean  @default(false) @map("will_invest")
  /// [TopCompaniesToConsider]
  topCompaniesToConsider Json[]   @map("top_companies_to_consider")
  tickerId               String   @map("ticker_id")
  spaceId                String   @default("koala_gains") @map("space_id")
  createdAt              DateTime @default(now()) @map("created_at")
  updatedAt              DateTime @updatedAt @map("updated_at")
  createdBy              String?  @map("created_by")
  updatedBy              String?  @map("updated_by")

  ticker TickerV1 @relation(fields: [tickerId], references: [id])

  @@unique([spaceId, tickerId, investorKey])
  @@index([spaceId, tickerId])
  @@index([tickerId])
  @@map("ticker_v1_investor_analysis_results")
}

model TickerV1FutureRisk {
  id               String   @id @default(uuid())
  summary          String   @map("summary")
  detailedAnalysis String   @map("detailed_analysis")
  tickerId         String   @map("ticker_id")
  spaceId          String   @default("koala_gains") @map("space_id")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  createdBy        String?  @map("created_by")
  updatedBy        String?  @map("updated_by")

  ticker TickerV1 @relation(fields: [tickerId], references: [id])

  @@unique([spaceId, tickerId])
  @@index([tickerId])
  @@index([spaceId, tickerId])
  @@map("ticker_v1_future_risks")
}

model TickerV1VsCompetition {
  id                       String   @id @default(uuid())
  summary                  String   @map("summary")
  overallAnalysisDetails   String   @map("introduction_to_analysis")
  // Store as a JSON value (can itself be a JSON array of objects)
  /// [CompetitionAnalysis]
  competitionAnalysisArray Json[]   @map("competition_analysis")
  tickerId                 String   @unique @map("ticker_id")
  spaceId                  String   @default("koala_gains") @map("space_id")
  createdAt                DateTime @default(now()) @map("created_at")
  updatedAt                DateTime @updatedAt @map("updated_at")
  createdBy                String?  @map("created_by")
  updatedBy                String?  @map("updated_by")

  ticker TickerV1 @relation(fields: [tickerId], references: [id])

  @@unique([spaceId, tickerId])
  @@index([spaceId, tickerId])
  @@index([tickerId])
  @@map("ticker_v1_vs_competition")
}

model TickerV1GenerationRequest {
  id       String @id @default(uuid())
  tickerId String @map("ticker_id")
  spaceId  String @default("koala_gains") @map("space_id")

  // Core analysis sections (true = regenerate this section)
  regenerateCompetition       Boolean @default(false) @map("regenerate_competition")
  regenerateFinancialAnalysis Boolean @default(false) @map("regenerate_financial_analysis")
  regenerateBusinessAndMoat   Boolean @default(false) @map("regenerate_business_and_moat")
  regeneratePastPerformance   Boolean @default(false) @map("regenerate_past_performance")
  regenerateFutureGrowth      Boolean @default(false) @map("regenerate_future_growth")
  regenerateFairValue         Boolean @default(false) @map("regenerate_fair_value")
  regenerateFutureRisk        Boolean @default(false) @map("regenerate_future_risk")

  // Investor analyses
  regenerateWarrenBuffett Boolean @default(false) @map("regenerate_warren_buffett")
  regenerateCharlieMunger Boolean @default(false) @map("regenerate_charlie_munger")
  regenerateBillAckman    Boolean @default(false) @map("regenerate_bill_ackman")

  // Final steps
  regenerateFinalSummary Boolean @default(false) @map("regenerate_final_summary")

  // Request status
  status String @default("NotStarted") @map("status")

  // Step tracking
  inProgressStep String?  @map("in_progress_step")
  completedSteps String[] @default([]) @map("completed_steps")
  failedSteps    String[] @default([]) @map("failed_steps")

  // Timestamps for tracking
  createdAt          DateTime  @default(now()) @map("created_at")
  updatedAt          DateTime  @updatedAt @map("updated_at")
  startedAt          DateTime? @map("started_at")
  completedAt        DateTime? @map("completed_at")
  lastInvocationTime DateTime? @map("last_invocation_time")

  // Relation
  ticker TickerV1 @relation(fields: [tickerId], references: [id], onDelete: Cascade)

  @@index([tickerId])
  @@index([status])
  @@index([tickerId, status]) // NEW: speeds up NOT EXISTS on ticker_id + status
  @@map("ticker_v1_generation_requests")
}

model TickerV1StockAnalyzerScrapperInfo {
  id String @id @default(uuid())

  // Summary data
  /// [StockFundamentalsSummary]
  summary              Json     @map("summary")
  lastUpdatedAtSummary DateTime @map("last_updated_at_summary")

  // Dividends data
  /// [DividendsData]
  dividends              Json     @map("dividends")
  lastUpdatedAtDividends DateTime @map("last_updated_at_dividends")

  // Income Statement data
  /// [IncomeAnnualData]
  incomeStatementAnnual               Json     @map("income_statement_annual")
  lastUpdatedAtIncomeStatementAnnual  DateTime @map("last_updated_at_income_statement_annual")
  /// [IncomeQuarterlyData]
  incomeStatementQuarter              Json     @map("income_statement_quarter")
  lastUpdatedAtIncomeStatementQuarter DateTime @map("last_updated_at_income_statement_quarter")

  // Balance Sheet data
  /// [BalanceSheetAnnualData]
  balanceSheetAnnual               Json     @map("balance_sheet_annual")
  lastUpdatedAtBalanceSheetAnnual  DateTime @map("last_updated_at_balance_sheet_annual")
  /// [BalanceSheetQuarterlyData]
  balanceSheetQuarter              Json     @map("balance_sheet_quarter")
  lastUpdatedAtBalanceSheetQuarter DateTime @map("last_updated_at_balance_sheet_quarter")

  // Cash Flow data
  /// [CashFlowAnnualData]
  cashFlowAnnual               Json     @map("cash_flow_annual")
  lastUpdatedAtCashFlowAnnual  DateTime @map("last_updated_at_cash_flow_annual")
  /// [CashFlowQuarterlyData]
  cashFlowQuarter              Json     @map("cash_flow_quarter")
  lastUpdatedAtCashFlowQuarter DateTime @map("last_updated_at_cash_flow_quarter")

  // Ratios data
  /// [RatiosAnnualData]
  ratiosAnnual               Json     @map("ratios_annual")
  lastUpdatedAtRatiosAnnual  DateTime @map("last_updated_at_ratios_annual")
  /// [RatiosQuarterlyData]
  ratiosQuarter              Json     @map("ratios_quarter")
  lastUpdatedAtRatiosQuarter DateTime @map("last_updated_at_ratios_quarter")

  // KPIs data
  /// [KpisAnnualData]
  kpisAnnual               Json?     @map("kpis_annual")
  lastUpdatedAtKpisAnnual  DateTime? @map("last_updated_at_kpis_annual")
  /// [KpisQuarterlyData]
  kpisQuarter              Json?     @map("kpis_quarter")
  lastUpdatedAtKpisQuarter DateTime? @map("last_updated_at_kpis_quarter")

  // Errors array
  errors Json[] @default([]) @map("errors")

  // Timestamps
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String?  @map("created_by")
  updatedBy String?  @map("updated_by")

  // Relation to TickerV1 (one-to-one)
  tickerId String   @unique @map("ticker_id")
  ticker   TickerV1 @relation(fields: [tickerId], references: [id], onDelete: Cascade)

  @@index([tickerId])
  @@map("ticker_v1_stock_analyzer_scrapper_info")
}

// --------------------------
// User Ticker Tags and Lists Models
// --------------------------

model UserTickerTag {
  id          String   @id @default(uuid())
  name        String   @map("name")
  description String?  @map("description")
  colorHex    String   @map("color_hex")
  userId      String   @map("user_id")
  spaceId     String   @default("koala_gains") @map("space_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String   @map("created_by")

  // Relation to User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relation to FavouriteTickers
  favouriteTickers FavouriteTicker[]

  // Relation to PortfolioTickers
  portfolioTickers PortfolioTicker[]

  @@unique([spaceId, userId, name])
  @@index([userId])
  @@map("user_ticker_tags")
}

model UserTickerList {
  id          String   @id @default(uuid())
  name        String   @map("name")
  description String?  @map("description")
  userId      String   @map("user_id")
  spaceId     String   @default("koala_gains") @map("space_id")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")
  createdBy   String   @map("created_by")

  // Relation to User
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  // Relation to FavouriteTickers
  favouriteTickers FavouriteTicker[]

  // Relation to PortfolioTickers
  portfolioTickers PortfolioTicker[]

  @@unique([spaceId, userId, name])
  @@index([userId])
  @@map("user_ticker_lists")
}

model FavouriteTicker {
  id                    String   @id @default(uuid())
  userId                String   @map("user_id")
  tickerId              String   @map("ticker_id")
  spaceId               String   @default("koala_gains") @map("space_id")
  myNotes               String?  @map("my_notes")
  myScore               Float?   @map("my_score")
  competitorsConsidered String[] @default([]) @map("competitors_considered")
  betterAlternatives    String[] @default([]) @map("better_alternatives")
  createdAt             DateTime @default(now()) @map("created_at")
  updatedAt             DateTime @updatedAt @map("updated_at")
  createdBy             String   @map("created_by")

  // Relations
  user   User             @relation(fields: [userId], references: [id], onDelete: Cascade)
  ticker TickerV1         @relation(fields: [tickerId], references: [id], onDelete: Cascade)
  tags   UserTickerTag[]
  lists  UserTickerList[]

  @@unique([spaceId, userId, tickerId])
  @@index([userId])
  @@index([tickerId])
  @@map("favourite_tickers")
}

model TickerV1Notes {
  id        String   @id @default(uuid())
  userId    String   @map("user_id")
  tickerId  String   @map("ticker_id")
  notes     String   @map("notes")
  score     Float?   @map("score")
  spaceId   String   @default("koala_gains") @map("space_id")
  createdAt DateTime @default(now()) @map("created_at")
  updatedAt DateTime @updatedAt @map("updated_at")
  createdBy String   @map("created_by")

  // Relations
  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  ticker TickerV1 @relation(fields: [tickerId], references: [id], onDelete: Cascade)

  @@unique([spaceId, userId, tickerId])
  @@index([userId])
  @@index([tickerId])
  @@map("ticker_v1_notes")
}

// --------------------------
// Portfolio Models
// --------------------------

model PortfolioManagerProfile {
  id                  String   @id @default(uuid())
  userId              String   @unique @map("user_id")
  headline            String   @map("headline")
  summary             String   @map("summary")
  detailedDescription String   @map("detailed_description")
  country             String   @map("country")
  managerType         String   @map("manager_type")
  isPublic            Boolean  @default(false) @map("is_public")
  profileImageUrl     String?  @map("profile_image_url")
  spaceId             String   @default("koala_gains") @map("space_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  createdBy           String   @map("created_by")
  updatedBy           String?  @map("updated_by")

  // Relations
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  portfolios Portfolio[]

  @@unique([spaceId, userId])
  @@index([userId])
  @@map("portfolio_manager_profiles")
}

model Portfolio {
  id                        String   @id @default(uuid())
  portfolioManagerProfileId String   @map("portfolio_manager_profile_id")
  name                      String   @map("name")
  summary                   String   @map("summary")
  detailedDescription       String   @map("detailed_description")
  spaceId                   String   @default("koala_gains") @map("space_id")
  createdAt                 DateTime @default(now()) @map("created_at")
  updatedAt                 DateTime @updatedAt @map("updated_at")
  createdBy                 String   @map("created_by")
  updatedBy                 String?  @map("updated_by")

  // Relations
  portfolioManagerProfile PortfolioManagerProfile @relation(fields: [portfolioManagerProfileId], references: [id], onDelete: Cascade)
  portfolioTickers        PortfolioTicker[]

  @@index([portfolioManagerProfileId])
  @@map("portfolios")
}

model PortfolioTicker {
  id                  String   @id @default(uuid())
  portfolioId         String   @map("portfolio_id")
  tickerId            String   @map("ticker_id")
  allocation          Float    @map("allocation") // Percentage of portfolio (0-100)
  detailedDescription String?  @map("detailed_description")
  competitors         String[] @default([]) @map("competitors") // Ticker symbols/IDs
  alternatives        String[] @default([]) @map("alternatives") // Ticker symbols/IDs
  spaceId             String   @default("koala_gains") @map("space_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  createdBy           String   @map("created_by")
  updatedBy           String?  @map("updated_by")

  // Relations
  portfolio Portfolio        @relation(fields: [portfolioId], references: [id], onDelete: Cascade)
  ticker    TickerV1         @relation(fields: [tickerId], references: [id], onDelete: Cascade)
  tags      UserTickerTag[]
  lists     UserTickerList[]

  @@unique([spaceId, portfolioId, tickerId]) // Prevent duplicate tickers in same portfolio
  @@index([portfolioId])
  @@index([tickerId])
  @@map("portfolio_tickers")
}

// --------------------------
// Daily Market Movement Models
// --------------------------

model DailyTopGainer {
  id                  String   @id @default(uuid())
  name                String   @map("name")
  symbol              String   @map("symbol")
  percentageChange    Float    @map("percentage_change")
  title               String?  @map("title")
  metaDescription     String?  @map("meta_description")
  oneLineExplanation  String?  @map("one_line_explanation")
  detailedExplanation String?  @map("detailed_explanation")
  status              String   @default("NotStarted") @map("status")
  tickerId            String   @map("ticker_id")
  spaceId             String   @default("koala_gains") @map("space_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  createdBy           String?  @map("created_by")
  updatedBy           String?  @map("updated_by")

  // Relations
  ticker TickerV1 @relation("DailyTopGainerTickers", fields: [tickerId], references: [id], onDelete: Cascade)

  @@unique([spaceId, symbol, createdAt])
  @@index([spaceId, createdAt])
  @@index([symbol])
  @@index([tickerId])
  @@map("daily_top_gainers")
}

model DailyTopLoser {
  id                  String   @id @default(uuid())
  name                String   @map("name")
  symbol              String   @map("symbol")
  percentageChange    Float    @map("percentage_change")
  title               String?  @map("title")
  metaDescription     String?  @map("meta_description")
  oneLineExplanation  String?  @map("one_line_explanation")
  detailedExplanation String?  @map("detailed_explanation")
  status              String   @default("NotStarted") @map("status")
  tickerId            String   @map("ticker_id")
  spaceId             String   @default("koala_gains") @map("space_id")
  createdAt           DateTime @default(now()) @map("created_at")
  updatedAt           DateTime @updatedAt @map("updated_at")
  createdBy           String?  @map("created_by")
  updatedBy           String?  @map("updated_by")

  // Relations
  ticker TickerV1 @relation("DailyTopLoserTickers", fields: [tickerId], references: [id], onDelete: Cascade)

  @@unique([spaceId, symbol, createdAt])
  @@index([spaceId, createdAt])
  @@index([symbol])
  @@index([tickerId])
  @@map("daily_top_losers")
}

// --------------------------
// Industry Analysis Models
// --------------------------

model TickerV1IndustryAnalysis {
  id             String   @id @default(uuid())
  name           String   @map("name")
  industryKey    String   @unique @map("industry_key")
  metaDescription String?  @map("meta_description")
  details        String?   @map("details")
  createdAt      DateTime @default(now()) @map("created_at")
  updatedAt      DateTime @updatedAt @map("updated_at")

  // Relations
  industry TickerV1Industry @relation(fields: [industryKey], references: [industryKey], onUpdate: Cascade, onDelete: Restrict)

  // Backrefs
  subIndustryAnalyses IndustryBuildingBlockAnalysis[]

  @@index([industryKey])
  @@map("ticker_v1_industry_analysis")
}

model IndustryBuildingBlockAnalysis {
  id                         String   @id @default(uuid())
  name                       String   @map("name")
  buildingBlockKey     String   @unique @map("building_block_key")
  tickerV1IndustryAnalysisId String   @map("ticker_v1_industry_analysis_id")
  metaDescription            String?  @map("meta_description")
  details                    String?   @map("details")
  createdAt                  DateTime @default(now()) @map("created_at")
  updatedAt                  DateTime @updatedAt @map("updated_at")

  // Relations
  industryAnalysis TickerV1IndustryAnalysis @relation(fields: [tickerV1IndustryAnalysisId], references: [id], onDelete: Cascade)

  @@index([tickerV1IndustryAnalysisId])
  @@index([buildingBlockKey])
  @@map("industry_building_block_analysis")
}

// --------------------------
// Detailed Reports Model
// --------------------------

model AnalysisTemplate {
  id          String   @id @default(uuid())
  name        String   @map("name")
  description String?  @map("description")
  promptId    String?  @map("prompt_id")
  promptKey   String?  @map("prompt_key")
  createdAt   DateTime @default(now()) @map("created_at")
  updatedAt   DateTime @updatedAt @map("updated_at")

  prompt               Prompt?               @relation(fields: [promptId], references: [id])
  categories            DetailedReportCategory[]
  tickerDetailedReports TickerV1DetailedReport[]

  @@map("analysis_templates")
}

model DetailedReportCategory {
  id                 String   @id @default(uuid())
  analysisTemplateId String   @map("analysis_template_id")
  name               String   @map("name")
  description        String?  @map("description")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  analysisTemplate AnalysisTemplate @relation(fields: [analysisTemplateId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  analysisTypes    AnalysisType[]

  @@index([analysisTemplateId])
  @@map("detailed_report_categories")
}

model AnalysisType {
  id                 String   @id @default(uuid())
  categoryId         String   @map("category_id")
  name               String   @map("name")
  description        String   @map("description")
  promptInstructions String?  @map("prompt_instructions")
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  category              DetailedReportCategory   @relation(fields: [categoryId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  tickerDetailedReports TickerV1DetailedReport[]

  @@index([categoryId])
  @@map("analysis_types")
}

model TickerV1DetailedReport {
  id                 String   @id @default(uuid())
  tickerId           String   @map("ticker_id")
  analysisTemplateId String   @map("analysis_template_id")
  analysisTypeId     String   @map("analysis_type_id")
  output             String   @map("output")
  result             String   @map("result")
  /// [SourceLink]
  sourceLinks        Json?    @map("source_links") 
  createdAt          DateTime @default(now()) @map("created_at")
  updatedAt          DateTime @updatedAt @map("updated_at")

  ticker           TickerV1         @relation(fields: [tickerId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  analysisTemplate AnalysisTemplate @relation(fields: [analysisTemplateId], references: [id], onUpdate: Cascade, onDelete: Cascade)
  analysisType     AnalysisType     @relation(fields: [analysisTypeId], references: [id], onUpdate: Cascade, onDelete: Cascade)

  @@index([tickerId])
  @@index([analysisTemplateId])
  @@index([analysisTypeId])
  @@map("ticker_v1_detailed_reports")
}