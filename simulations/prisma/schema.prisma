generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum BusinessSubject {
  HR
  ECONOMICS
  MARKETING
  FINANCE
  OPERATIONS
}

model CaseStudy {
  id               String   @id @default(uuid())
  title            String   @map("title")
  shortDescription String   @map("short_description")
  details          String   @db.Text @map("details")
  subject          BusinessSubject @map("subject")
  createdBy        String?  @map("created_by") // created by admin
  updatedBy        String?  @map("updated_by") // updated by admin
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")
  archive          Boolean  @default(false) @map("archive")

  modules      CaseStudyModule[] @relation("CaseStudyToModules")
  enrollments  ClassCaseStudyEnrollment[] @relation("CaseStudyToEnrollments")

  @@map("case_studies")
}

model CaseStudyModule {
  id               String    @id @default(uuid())
  caseStudyId      String    @map("case_study_id")
  caseStudy        CaseStudy @relation("CaseStudyToModules", fields: [caseStudyId], references: [id])

  title            String    @map("title")
  shortDescription String    @map("short_description")
  details          String    @db.Text @map("details")
  orderNumber      Int       @map("order_number")
  createdBy        String?   @map("created_by") // created by admin
  updatedBy        String?   @map("updated_by") // updated by admin
  createdAt        DateTime  @default(now()) @map("created_at")
  updatedAt        DateTime  @updatedAt @map("updated_at")
  archive          Boolean  @default(false) @map("archive")

  exercises ModuleExercise[] @relation("ModuleToExercises")

  @@map("case_study_modules")
}

model ClassCaseStudyEnrollment {
  id          String    @id @default(uuid())
  caseStudyId String    @map("case_study_id")
  caseStudy   CaseStudy @relation("CaseStudyToEnrollments", fields: [caseStudyId], references: [id])

  assignedInstructorId String @map("assigned_instructor_id") // assigned by admin but store instructor email

  createdBy   String?   @map("created_by") // created by admin
  updatedBy   String?   @map("updated_by") // updated by admin
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")
  archive          Boolean  @default(false) @map("archive")

  students     EnrollmentStudent[]

  @@map("case_study_enrollments")
}

model EnrollmentStudent {
  id             String               @id @default(uuid())
  enrollmentId   String               @map("enrollment_id")
  enrollment     ClassCaseStudyEnrollment  @relation(fields: [enrollmentId], references: [id])

  assignedStudentId String @map("assigned_student_id") // assigned by admin but store student email

  instructionReadStatus Json? @map("instruction_read_status")

  createdBy      String?              @map("created_by") // created by admin
  updatedBy      String?              @map("updated_by") // updated by admin
  createdAt      DateTime             @default(now()) @map("created_at")
  updatedAt      DateTime             @updatedAt @map("updated_at")
  archive          Boolean  @default(false) @map("archive")

  @@unique([enrollmentId, assignedStudentId], map: "uq_enrollment_student")
  
  @@map("enrollment_students")
  finalSubmission FinalSubmission?
}

model ModuleExercise {
  id               String           @id @default(uuid()) @map("id")
  moduleId         String           @map("module_id")
  module           CaseStudyModule  @relation("ModuleToExercises", fields: [moduleId], references: [id])

  title            String           @map("title")
  shortDescription String           @map("short_description")
  details          String           @db.Text @map("details")
  promptHint       String?          @map("prompt_hint")
  orderNumber      Int              @map("order_number")
  createdBy        String?          @map("created_by") // created by admin
  updatedBy        String?          @map("updated_by") // updated by admin
  createdAt        DateTime         @default(now()) @map("created_at")
  updatedAt        DateTime         @updatedAt @map("updated_at")
  archive          Boolean  @default(false) @map("archive")

  attempts ExerciseAttempt[] @relation("ExerciseToAttempts")

  @@map("module_exercises")
}

model ExerciseAttempt {
  id             String         @id @default(uuid()) @map("id")
  exerciseId     String         @map("exercise_id")
  exercise       ModuleExercise @relation("ExerciseToAttempts", fields: [exerciseId], references: [id])

  createdBy      String?        @map("created_by") // created by student
  updatedBy      String?        @map("updated_by") // updated by student
  attemptNumber  Int            @map("attempt_number")
  model          String?        @map("model")
  prompt         String?        @db.Text @map("prompt")
  promptResponse String?        @db.Text @map("prompt_response")
  status         String?        @map("status")
  error          String?        @map("error")
  createdAt      DateTime       @default(now()) @map("created_at")
  updatedAt      DateTime       @default(now()) @updatedAt @map("updated_at")
  archive          Boolean  @default(false) @map("archive")

  @@map("exercise_attempts")
}

model FinalSubmission {
  id           String    @id @default(uuid()) @map("id")

  studentId     String    @unique @map("student_id")
  student       EnrollmentStudent @relation(fields: [studentId], references: [id])

  createdBy    String?   @map("created_by") // created by student
  updatedBy    String?   @map("updated_by") // updated by student
  finalContent String?   @db.Text @map("final_content")
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")
  archive          Boolean  @default(false) @map("archive")

  @@map("final_submissions")
}
